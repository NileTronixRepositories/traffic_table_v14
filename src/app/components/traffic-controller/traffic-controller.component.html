<div class="container-fluid">
  <div class="header">
    <h1 class="title">Traffic Controller</h1>

    <div class="search-container">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input
          type="text"
          class="search-input"
          placeholder="Search by name or ID..."
          [(ngModel)]="searchTerm"
        />
      </div>

      <!-- Status Filter -->
      <div class="filter-dropdown status-filter-dropdown">
        <button class="filter-button" (click)="toggleStatusFilterDropdown()">
          <i class="fas fa-filter"></i>
          Status Filter
          <i class="fas fa-chevron-down" [class.rotated]="showStatusFilter"></i>
        </button>
        <div class="filter-menu" [class.show]="showStatusFilter">
          <div class="filter-option" (click)="toggleAllStatusFilters()">
            <span class="checkmark">
              {{ allStatusSelected ? "‚úì" : someStatusSelected ? "‚Äì" : "" }}
            </span>
            <span>Filter All</span>
          </div>
          <div class="filter-divider"></div>
          <div
            class="filter-option"
            *ngFor="let status of signalColors"
            (click)="toggleStatusFilter(status)"
          >
            <span
              class="status-dot"
              [style.background]="statusColors[status]"
            ></span>
            <span>{{ status }}</span>
            <span class="checkmark">{{ statusFilter[status] ? "‚úì" : "" }}</span>
          </div>
        </div>
      </div>

      <!-- Active Filter -->
      <div class="filter-dropdown active-filter-dropdown">
        <button class="filter-button" (click)="toggleActiveFilterDropdown()">
          <i class="fas fa-power-off"></i>
          Active Filter
          <i class="fas fa-chevron-down" [class.rotated]="showActiveFilter"></i>
        </button>
        <div class="filter-menu" [class.show]="showActiveFilter">
          <div class="filter-option" (click)="activeFilter = 'ALL'">
            <span>All</span>
            <span class="checkmark">{{
              activeFilter === "ALL" ? "‚úì" : ""
            }}</span>
          </div>
          <div class="filter-option" (click)="activeFilter = 'ACTIVE'">
            <span>Active Only</span>
            <span class="checkmark">{{
              activeFilter === "ACTIVE" ? "‚úì" : ""
            }}</span>
          </div>
          <div class="filter-option" (click)="activeFilter = 'INACTIVE'">
            <span>Inactive Only</span>
            <span class="checkmark">{{
              activeFilter === "INACTIVE" ? "‚úì" : ""
            }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <table class="traffic-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>IpAddress</th>
        <th>Name</th>
        <th>Pattern</th>
        <th>Current</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let traffic of paginatedTraffics"
        (mouseenter)="showPopup(traffic, $event)"
        (mousemove)="movePopup($event)"
        (mouseleave)="hidePopup()"
      >
        <td>{{ traffic.id }}</td>
        <td>{{ traffic.ipAddress }}</td>
        <td>{{ traffic.name }}</td>
        <!-- <td>
          <span [ngClass]="traffic.active ? 'active' : 'inactive'">
            {{ traffic.active ? activeLabel : inactiveLabel }}
          </span>
        </td> -->
        <!-- Pattern column (ÿßŸÑÿßÿ≥ŸÖ ŸÅŸÇÿ∑) -->
        <td class="pattern-cell">
          <select
            class="form-select custom-select"
            [(ngModel)]="selectedPatternId[traffic.id]"
            (ngModelChange)="onPatternSelected(traffic, $event)"
            [disabled]="isLoadingPatterns || !patterns.length"
          >
            <option [ngValue]="null" disabled>
              {{
                isLoadingPatterns
                  ? "Loading..."
                  : patternLoadError
                  ? "Failed - refresh"
                  : "Choose..."
              }}
            </option>
            <option *ngFor="let p of patterns" [ngValue]="p.id">
              {{ p.name }}
            </option>
          </select>
        </td>
        <!-- Apply column -->
        <td class="apply-cell">
          <button
            class="btn btn-success"
            (click)="applySelected(traffic)"
            [disabled]="selectedPatternId[traffic.id] == null"
            title="Apply selected pattern to this signal"
          >
            Apply
          </button>
        </td>
        <!-- <td> <button class="btn btn-success" (click)="applyCurrent(traffic, $event)"> Apply (old) </button> </td> -->
      </tr>
      <tr *ngIf="paginatedTraffics.length === 0">
        <td colspan="6" class="no-results">
          No traffic signals found matching your criteria
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Popup -->
  <div
    class="traffic-popup"
    *ngIf="popupVisible"
    [ngStyle]="{ top: popupY + 'px', left: popupX + 'px' }"
  >
    <!-- Header -->
    <div class="tp-header">
      <div class="tp-title">
        <span
          class="tp-dot"
          [class.connected]="!popupDisconnected"
          [class.disconnected]="popupDisconnected"
        ></span>
        <span class="tp-name">{{ popupData?.name || "‚Äî" }}</span>
      </div>
      <span class="tp-chip" [class.tp-chip--danger]="popupDisconnected">
        {{ popupDisconnected ? "Disconnected" : "Live" }}
      </span>
    </div>

    <!-- Coordinates -->
    <div class="tp-meta">
      <div class="tp-meta__item">
        <i class="tp-ico">üìç</i>
        <span>{{ popupData?.Latitude || "‚Äî" }}</span>
      </div>
      <div class="tp-meta__sep">‚Ä¢</div>
      <div class="tp-meta__item">
        <i class="tp-ico">üß≠</i>
        <span>{{ popupData?.Longitude || "‚Äî" }}</span>
      </div>
    </div>

    <!-- Grid -->
    <div class="tp-grid">
      <!-- L1 -->
      <div class="tp-col">
        <div class="tp-col__head">
          <span class="tp-col__label">L1</span>
          <span
            class="tp-timer"
            [class.tp-timer--warn]="(popupData?.T1 ?? 0) <= 5"
            [class.tp-timer--ok]="(popupData?.T1 ?? 0) > 5"
            >{{ popupData?.T1 ?? 0 }}s</span
          >
        </div>

        <div
          class="tp-lamp"
          [class.is-red]="mapSignalColor(popupData?.L1) === 'RED'"
          [class.is-green]="mapSignalColor(popupData?.L1) === 'GREEN'"
          [class.is-yellow]="mapSignalColor(popupData?.L1) === 'YELLOW'"
        >
          {{ getEmoji(mapSignalColor(popupData?.L1)) }}
        </div>

        <div class="tp-legend">
          <span
            class="tp-dot sm red"
            [class.on]="mapSignalColor(popupData?.L1) === 'RED'"
          ></span>
          <span
            class="tp-dot sm green"
            [class.on]="mapSignalColor(popupData?.L1) === 'GREEN'"
          ></span>
          <span
            class="tp-dot sm yellow"
            [class.on]="mapSignalColor(popupData?.L1) === 'YELLOW'"
          ></span>
        </div>
      </div>

      <!-- L2 -->
      <div class="tp-col">
        <div class="tp-col__head">
          <span class="tp-col__label">L2</span>
          <span
            class="tp-timer"
            [class.tp-timer--warn]="(popupData?.T2 ?? 0) <= 5"
            [class.tp-timer--ok]="(popupData?.T2 ?? 0) > 5"
            >{{ popupData?.T2 ?? 0 }}s</span
          >
        </div>

        <div
          class="tp-lamp"
          [class.is-red]="mapSignalColor(popupData?.L2) === 'RED'"
          [class.is-green]="mapSignalColor(popupData?.L2) === 'GREEN'"
          [class.is-yellow]="mapSignalColor(popupData?.L2) === 'YELLOW'"
        >
          {{ getEmoji(mapSignalColor(popupData?.L2)) }}
        </div>

        <div class="tp-legend">
          <span
            class="tp-dot sm red"
            [class.on]="mapSignalColor(popupData?.L2) === 'RED'"
          ></span>
          <span
            class="tp-dot sm green"
            [class.on]="mapSignalColor(popupData?.L2) === 'GREEN'"
          ></span>
          <span
            class="tp-dot sm yellow"
            [class.on]="mapSignalColor(popupData?.L2) === 'YELLOW'"
          ></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer / Pagination -->
  <div class="footer">
    <p>
      Showing {{ paginatedTraffics.length }} of
      {{ filteredTraffics.length }} traffic signals
    </p>
    <div class="pagination">
      <button
        class="prev-btn"
        (click)="prevPage()"
        [disabled]="currentPage === 1"
      >
        Previous
      </button>
      <span>Page {{ currentPage }} of {{ totalPages }}</span>
      <button
        class="next-btn"
        (click)="nextPage()"
        [disabled]="currentPage === totalPages"
      >
        Next
      </button>
    </div>
  </div>
</div>
